<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buad | Live Stream</title>

  <link rel="stylesheet" href="/static/style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
  <div class="page-bg"></div>

  <header class="site-header">
    <nav class="container flex-between">
      <a href="/" class="brand">Buad</a>
      <ul class="nav">
        <li><a href="/home">Home</a></li>
        <li><a class="active" href="/ui/live">Live</a></li>
        <li><a href="/ui/dashboard">Dashboard</a></li>
        <li><a href="/ui/chat">Chatbot</a></li>
      </ul>
      <button class="icon-btn" title="Dark only"><i class="fa-solid fa-moon"></i></button>
    </nav>
  </header>

  <section class="hero container">
    <div>
      <h1>Live Stream</h1>
      <p>Start or stop the camera stream and view detections in real time.</p>
      <div class="tabs" style="margin-top:1rem">
        <span id="runBadge" class="btn-chip" style="pointer-events:none;opacity:.9">Status: Stopped</span>
      </div>
    </div>
  </section>

  <section class="section container">
    <div class="filter-bar">
      <div class="filter-grid">
        <div class="field" style="grid-column:span 6;">
          <label>Camera ID</label>
          <input id="camId" type="text" value="cam01"/>
        </div>
        <div class="field" style="grid-column:span 6;">
          <label>Source</label>
          <input id="source" type="text" value="0"/>
        </div>
      </div>

      <div style="display:flex; gap:.6rem; margin-top:1rem; flex-wrap:wrap">
        <button id="startBtn" class="btn-chip"><i class="fa-solid fa-play"></i> Start</button>
        <button id="stopBtn"  class="btn-chip"><i class="fa-solid fa-stop"></i> Stop</button>
        <span id="msg" class="small" style="margin-left:.5rem; opacity:.85"></span>
      </div>
    </div>

    <!-- live view -->
    <div style="margin-top:1rem">
      <div class="image-shell">
        <img id="liveImg" class="thumb" alt="live stream" src="" />
      </div>
      <div id="hint" class="small note" style="margin-top:.6rem">
        Stream is not running.
      </div>
    </div>
  </section>

  <div class="footer-gap"></div>

  <script>
    "use strict";

    const BACKEND = (window.CONFIG && window.CONFIG.BACKEND) || "http://localhost:8000";

    const camId   = document.getElementById("camId");
    const source  = document.getElementById("source");
    const runBadge= document.getElementById("runBadge");
    const startBtn= document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const img     = document.getElementById("liveImg");
    const hint    = document.getElementById("hint");
    const msg     = document.getElementById("msg");

    let running = false;

    function setRunning(on){
      running = on;
      runBadge.textContent = on ? "Status: Running" : "Status: Stopped";
      runBadge.classList.toggle("active", on);
      hint.textContent = on ? "Streaming..." : "Stream is not running.";
      if(!on){
        img.removeAttribute("src");
      }
    }

    function streamUrl(){
      const params = new URLSearchParams({
        camera_id: camId.value.trim() || "cam01",
        source:    source.value.trim() || "0"
      });
      return `${BACKEND}/stream?${params.toString()}`;
    }

    async function post(url){
      const r = await fetch(url, { method:"POST" });
      if(!r.ok) throw new Error(String(r.status));
      return r.json().catch(()=> ({}));
    }

    async function handleStart(){
      msg.textContent = "";
      try{
        const cid = camId.value.trim() || "cam01";
        await post(`${BACKEND}/stream/start?camera_id=${encodeURIComponent(cid)}`);
        img.src = streamUrl();
        setRunning(true);
        msg.textContent = "Stream running";
      }catch(e){
        msg.textContent = "Failed to start stream.";
      }
    }

    async function handleStop(){
      msg.textContent = "";
      try{
        const cid = camId.value.trim() || "cam01";
        await post(`${BACKEND}/stream/stop?camera_id=${encodeURIComponent(cid)}`);
        setRunning(false);
        msg.textContent = "Stream stopped";
      }catch(e){
        msg.textContent = "Failed to stop stream.";
      }
    }

    startBtn.addEventListener("click", handleStart);
    stopBtn.addEventListener("click", handleStop);

    [camId, source].forEach(el=>{
      el.addEventListener("change", ()=>{
        if(running){ img.src = streamUrl(); }
      });
    });

    setRunning(false);
  </script>
</body>
</html>
